var findChild,getNodeName,getNodePosition,simpleXPathJQuery,simpleXPathPure;simpleXPathJQuery=function(a){var b;b=this.map(function(){var e,c,f,d;f="";e=this;while((e!=null?e.nodeType:void 0)===Node.ELEMENT_NODE&&e!==a){d=e.tagName.replace(":","\\:");c=$(e.parentNode).children(d).index(e)+1;c="["+c+"]";f="/"+e.tagName.toLowerCase()+c+f;e=e.parentNode}return f});return b.get()};simpleXPathPure=function(c){var d,b,e,a;d=function(h){var f,i;f=getNodeName(h);i=getNodePosition(h);return""+f+"["+i+"]"};a=c;b=function(h){var f;f="";while(h!==a){if(h==null){throw new Error("Called getPathTo on a node which was not a descendant of @rootNode. "+a)}f=(d(h))+"/"+f;h=h.parentNode}f="/"+f;f=f.replace(/\/$/,"");return f};e=this.map(function(){var f;f=b(this);return f});return e.get()};findChild=function(d,h,f){var b,c,j,a,e,i;if(!d.hasChildNodes()){throw new Error("XPath error: node has no children!")}c=d.childNodes;j=0;for(e=0,i=c.length;e<i;e++){b=c[e];a=getNodeName(b);if(a===h){j+=1;if(j===f){return b}}}throw new Error("XPath error: wanted child not found.")};getNodeName=function(a){var b;b=a.nodeName.toLowerCase();switch(b){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return b}};getNodePosition=function(b){var c,a;c=0;a=b;while(a){if(a.nodeName===b.nodeName){c++}a=a.previousSibling}return c};var $,Util,gettext,_gettext,_ref,_t;gettext=null;if(typeof Gettext!=="undefined"&&Gettext!==null){_gettext=new Gettext({domain:"annotator"});gettext=function(a){return _gettext.gettext(a)}}else{gettext=function(a){return a}}_t=function(a){return gettext(a)};if(!(typeof jQuery!=="undefined"&&jQuery!==null?(_ref=jQuery.fn)!=null?_ref.jquery:void 0:void 0)){console.error(_t("Annotator requires jQuery: have you included lib/vendor/jquery.js?"))}if(!(JSON&&JSON.parse&&JSON.stringify)){console.error(_t("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?"))}$=jQuery;Util={};Util.flatten=function(b){var a;a=function(d){var e,h,f,c;h=[];for(f=0,c=d.length;f<c;f++){e=d[f];h=h.concat(e&&$.isArray(e)?a(e):e)}return h};return a(b)};Util.contains=function(a,c){var b;b=c;while(b!=null){if(b===a){return true}b=b.parentNode}return false};Util.getTextNodes=function(b){var a;a=function(d){var c;if(d&&d.nodeType!==Node.TEXT_NODE){c=[];if(d.nodeType!==Node.COMMENT_NODE){d=d.lastChild;while(d){c.push(a(d));d=d.previousSibling}}return c.reverse()}else{return d}};return b.map(function(){return Util.flatten(a(this))})};Util.getLastTextNodeUpTo=function(b){var a;switch(b.nodeType){case Node.TEXT_NODE:return b;case Node.ELEMENT_NODE:if(b.lastChild!=null){a=Util.getLastTextNodeUpTo(b.lastChild);if(a!=null){return a}}break}b=b.previousSibling;if(b!=null){return Util.getLastTextNodeUpTo(b)}else{return null}};Util.getFirstTextNodeNotBefore=function(b){var a;switch(b.nodeType){case Node.TEXT_NODE:return b;case Node.ELEMENT_NODE:if(b.firstChild!=null){a=Util.getFirstTextNodeNotBefore(b.firstChild);if(a!=null){return a}}break}b=b.nextSibling;if(b!=null){return Util.getFirstTextNodeNotBefore(b)}else{return null}};Util.readRangeViaSelection=function(a){var b;b=Util.getGlobal().getSelection();b.removeAllRanges();b.addRange(a.toRange());return b.toString()};Util.xpathFromNode=function(c,d){var b,a;try{a=simpleXPathJQuery.call(c,d)}catch(e){b=e;console.log("jQuery-based XPath construction failed! Falling back to manual.");a=simpleXPathPure.call(c,d)}return a};Util.nodeFromXPath=function(f,i){var k,a,c,b,h,e,j,d;h=f.substring(1).split("/");c=i;for(e=0,j=h.length;e<j;e++){b=h[e];d=b.split("["),a=d[0],k=d[1];k=k!=null?parseInt((k!=null?k.split("]"):void 0)[0]):1;c=findChild(c,a.toLowerCase(),k)}return c};Util.escape=function(a){return a.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};Util.uuid=(function(){var a;a=0;return function(){return a++}})();Util.getGlobal=function(){return(function(){return this})()};Util.maxZIndex=function(c){var b,a;b=(function(){var f,e,d;d=[];for(f=0,e=c.length;f<e;f++){a=c[f];if($(a).css("position")==="static"){d.push(-1)}else{d.push(parseInt($(a).css("z-index"),10)||-1)}}return d})();return Math.max.apply(Math,b)};Util.mousePosition=function(b,d){var c,a;if((a=$(d).css("position"))!=="absolute"&&a!=="fixed"&&a!=="relative"){d=$(d).offsetParent()[0]}c=$(d).offset();return{top:b.pageY-c.top,left:b.pageX-c.left}};Util.preventEventDefault=function(a){return a!=null?typeof a.preventDefault==="function"?a.preventDefault():void 0:void 0};var fn,functions,_i,_j,_len,_len1,__slice=[].slice;functions=["log","debug","info","warn","exception","assert","dir","dirxml","trace","group","groupEnd","groupCollapsed","time","timeEnd","profile","profileEnd","count","clear","table","error","notifyFirebug","firebug","userObjects"];if(typeof console!=="undefined"&&console!==null){if(console.group==null){console.group=function(a){return console.log("GROUP: ",a)}}if(console.groupCollapsed==null){console.groupCollapsed=console.group}for(_i=0,_len=functions.length;_i<_len;_i++){fn=functions[_i];if(console[fn]==null){console[fn]=function(){return console.log(_t("Not implemented:")+(" console."+name))}}}}else{this.console={};for(_j=0,_len1=functions.length;_j<_len1;_j++){fn=functions[_j];this.console[fn]=function(){}}this.console.error=function(){var a;a=1<=arguments.length?__slice.call(arguments,0):[];return alert("ERROR: "+(a.join(", ")))};this.console.warn=function(){var a;a=1<=arguments.length?__slice.call(arguments,0):[];return alert("WARNING: "+(a.join(", ")))}}var Delegator,__slice=[].slice,__hasProp={}.hasOwnProperty;Delegator=(function(){a.prototype.events={};a.prototype.options={};a.prototype.element=null;function a(c,b){this.options=$.extend(true,{},this.options,b);this.element=$(c);this._closures={};this.on=this.subscribe;this.addEvents()}a.prototype.addEvents=function(){var d,f,c,e,b;e=a._parseEvents(this.events);b=[];for(f=0,c=e.length;f<c;f++){d=e[f];b.push(this._addEvent(d.selector,d.event,d.functionName))}return b};a.prototype.removeEvents=function(){var d,f,c,e,b;e=a._parseEvents(this.events);b=[];for(f=0,c=e.length;f<c;f++){d=e[f];b.push(this._removeEvent(d.selector,d.event,d.functionName))}return b};a.prototype._addEvent=function(b,c,d){var f,e=this;f=function(){return e[d].apply(e,arguments)};if(b===""&&a._isCustomEvent(c)){this.subscribe(c,f)}else{this.element.delegate(b,c,f)}this._closures[""+b+"/"+c+"/"+d]=f;return this};a.prototype._removeEvent=function(b,c,d){var e;e=this._closures[""+b+"/"+c+"/"+d];if(b===""&&a._isCustomEvent(c)){this.unsubscribe(c,e)}else{this.element.undelegate(b,c,e)}delete this._closures[""+b+"/"+c+"/"+d];return this};a.prototype.publish=function(){this.element.triggerHandler.apply(this.element,arguments);return this};a.prototype.subscribe=function(b,d){var c;c=function(){return d.apply(this,[].slice.call(arguments,1))};c.guid=d.guid=($.guid+=1);this.element.bind(b,c);return this};a.prototype.unsubscribe=function(){this.element.unbind.apply(this.element,arguments);return this};return a})();Delegator._parseEvents=function(b){var d,c,i,h,a,f,e;c=[];for(h in b){i=b[h];e=h.split(" "),a=2<=e.length?__slice.call(e,0,f=e.length-1):(f=0,[]),d=e[f++];c.push({selector:a.join(" "),event:d,functionName:i})}return c};Delegator.natives=(function(){var b,a,c;a=(function(){var e,d;e=jQuery.event.special;d=[];for(b in e){if(!__hasProp.call(e,b)){continue}c=e[b];d.push(b)}return d})();return"blur focus focusin focusout load resize scroll unload click dblclick\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\nchange select submit keydown keypress keyup error".split(/[^a-z]+/).concat(a)})();Delegator._isCustomEvent=function(a){a=a.split(".")[0];return $.inArray(a,Delegator.natives)===-1};var Range,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Range={};Range.sniff=function(a){if(a.commonAncestorContainer!=null){return new Range.BrowserRange(a)}else{if(typeof a.start==="string"){return new Range.SerializedRange(a)}else{if(a.start&&typeof a.start==="object"){return new Range.NormalizedRange(a)}else{console.error(_t("Could not sniff range type"));return false}}}};Range.nodeFromXPath=function(b,a){var h,f,c,e,d;if(a==null){a=document}f=function(k,i){var j;if(i==null){i=null}try{return document.evaluate("."+k,a,i,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(l){j=l;console.log("XPath evaluation failed.");console.log("Trying fallback...");return Util.nodeFromXPath(k,a)}};if(!$.isXMLDoc(document.documentElement)){return f(b)}else{h=document.createNSResolver(document.ownerDocument===null?document.documentElement:document.ownerDocument.documentElement);e=f(b,h);if(!e){b=((function(){var l,j,k,i;k=b.split("/");i=[];for(l=0,j=k.length;l<j;l++){d=k[l];if(d&&d.indexOf(":")===-1){i.push(d.replace(/^([a-z]+)/,"xhtml:$1"))}else{i.push(d)}}return i})()).join("/");c=document.lookupNamespaceURI(null);h=function(i){if(i==="xhtml"){return c}else{return document.documentElement.getAttribute("xmlns:"+i)}};e=f(b,h)}return e}};Range.RangeError=(function(a){__extends(b,a);function b(d,e,c){this.type=d;this.message=e;this.parent=c!=null?c:null;b.__super__.constructor.call(this,this.message)}return b})(Error);Range.BrowserRange=(function(){function a(b){this.commonAncestorContainer=b.commonAncestorContainer;this.startContainer=b.startContainer;this.startOffset=b.startOffset;this.endContainer=b.endContainer;this.endOffset=b.endOffset}a.prototype.normalize=function(b){var f,e,d,c;if(this.tainted){console.error(_t("You may only call normalize() once on a BrowserRange!"));return false}else{this.tainted=true}c={};if(this.startContainer.nodeType===Node.ELEMENT_NODE){c.start=Util.getFirstTextNodeNotBefore(this.startContainer.childNodes[this.startOffset]);c.startOffset=0}else{c.start=this.startContainer;c.startOffset=this.startOffset}if(this.endContainer.nodeType===Node.ELEMENT_NODE){e=this.endContainer.childNodes[this.endOffset];if(e!=null){f=e;while((f!=null)&&(f.nodeType!==Node.TEXT_NODE)){f=f.firstChild}if(f!=null){c.end=f;c.endOffset=0}}if(c.end==null){e=this.endContainer.childNodes[this.endOffset-1];c.end=Util.getLastTextNodeUpTo(e);c.endOffset=c.end.nodeValue.length}}else{c.end=this.endContainer;c.endOffset=this.endOffset}d={};if(c.startOffset>0){if(c.start.nodeValue.length>c.startOffset){d.start=c.start.splitText(c.startOffset)}else{d.start=c.start.nextSibling}}else{d.start=c.start}if(c.start===c.end){if(d.start.nodeValue.length>(c.endOffset-c.startOffset)){d.start.splitText(c.endOffset-c.startOffset)}d.end=d.start}else{if(c.end.nodeValue.length>c.endOffset){c.end.splitText(c.endOffset)}d.end=c.end}d.commonAncestor=this.commonAncestorContainer;while(d.commonAncestor.nodeType!==Node.ELEMENT_NODE){d.commonAncestor=d.commonAncestor.parentNode}return new Range.NormalizedRange(d)};a.prototype.serialize=function(b,c){return this.normalize(b).serialize(b,c)};return a})();Range.NormalizedRange=(function(){function a(b){this.commonAncestor=b.commonAncestor;this.start=b.start;this.end=b.end}a.prototype.normalize=function(b){return this};a.prototype.limit=function(f){var c,e,d,i,b,h;c=$.grep(this.textNodes(),function(j){return j.parentNode===f||$.contains(f,j.parentNode)});if(!c.length){return null}this.start=c[0];this.end=c[c.length-1];d=$(this.start).parents();h=$(this.end).parents();for(i=0,b=h.length;i<b;i++){e=h[i];if(d.index(e)!==-1){this.commonAncestor=e;break}}return this};a.prototype.serialize=function(d,e){var c,b,f;b=function(k,j){var i,h,m,r,p,o,l,q;if(e){r=$(k).parents(":not("+e+")").eq(0)}else{r=$(k).parent()}o=Util.xpathFromNode(r,d)[0];p=Util.getTextNodes(r);h=p.slice(0,p.index(k));m=0;for(l=0,q=h.length;l<q;l++){i=h[l];m+=i.nodeValue.length}if(j){return[o,m+k.nodeValue.length]}else{return[o,m]}};f=b(this.start);c=b(this.end,true);return new Range.SerializedRange({start:f[0],end:c[0],startOffset:f[1],endOffset:c[1]})};a.prototype.text=function(){var b;return((function(){var f,d,e,c;e=this.textNodes();c=[];for(f=0,d=e.length;f<d;f++){b=e[f];c.push(b.nodeValue)}return c}).call(this)).join("")};a.prototype.textNodes=function(){var b,e,c,d;c=Util.getTextNodes($(this.commonAncestor));d=[c.index(this.start),c.index(this.end)],e=d[0],b=d[1];return $.makeArray(c.slice(e,+b+1||9000000000))};a.prototype.toRange=function(){var b;b=document.createRange();b.setStartBefore(this.start);b.setEndAfter(this.end);return b};return a})();Range.SerializedRange=(function(){function a(b){this.start=b.start;this.startOffset=b.startOffset;this.end=b.end;this.endOffset=b.endOffset}a.prototype.normalize=function(o){var h,n,d,f,c,m,t,s,k,j,q,b,l,i;m={};l=["start","end"];for(k=0,q=l.length;k<q;k++){c=l[k];try{f=Range.nodeFromXPath(this[c],o)}catch(r){n=r;throw new Range.RangeError(c,("Error while finding "+c+" node: "+this[c]+": ")+n,n)}if(!f){throw new Range.RangeError(c,"Couldn't find "+c+" node: "+this[c])}d=0;t=this[c+"Offset"];if(c==="end"){t--}i=Util.getTextNodes($(f));for(j=0,b=i.length;j<b;j++){s=i[j];if(d+s.nodeValue.length>t){m[c+"Container"]=s;m[c+"Offset"]=this[c+"Offset"]-d;break}else{d+=s.nodeValue.length}}if(m[c+"Offset"]==null){throw new Range.RangeError(""+c+"offset","Couldn't find offset "+this[c+"Offset"]+" in element "+this[c])}}h=document.compareDocumentPosition==null?function(p,e){return p.contains(e)}:function(p,e){return p.compareDocumentPosition(e)&16};$(m.startContainer).parents().each(function(){if(h(this,m.endContainer)){m.commonAncestorContainer=this;return false}});return new Range.BrowserRange(m).normalize(o)};a.prototype.serialize=function(b,c){return this.normalize(b).serialize(b,c)};a.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}};return a})();var Annotator,g,_Annotator,_ref,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};_Annotator=this.Annotator;Annotator=(function(a){__extends(b,a);b.prototype.events={".annotator-adder button click":"onAdderClick",".annotator-adder button mousedown":"onAdderMousedown",".annotator-hl mouseover":"onHighlightMouseover",".annotator-hl mouseout":"startViewerHideTimer"};b.prototype.html={adder:'<div class="annotator-adder"><button>'+_t("Annotate")+"</button></div>",wrapper:'<div class="annotator-wrapper"></div>'};b.prototype.options={readOnly:false};b.prototype.plugins={};b.prototype.editor=null;b.prototype.viewer=null;b.prototype.selectedRanges=null;b.prototype.mouseIsDown=false;b.prototype.ignoreMouseup=false;b.prototype.viewerHideTimer=null;function b(d,c){this.onDeleteAnnotation=__bind(this.onDeleteAnnotation,this);this.onEditAnnotation=__bind(this.onEditAnnotation,this);this.onAdderClick=__bind(this.onAdderClick,this);this.onAdderMousedown=__bind(this.onAdderMousedown,this);this.onHighlightMouseover=__bind(this.onHighlightMouseover,this);this.checkForEndSelection=__bind(this.checkForEndSelection,this);this.checkForStartSelection=__bind(this.checkForStartSelection,this);this.clearViewerHideTimer=__bind(this.clearViewerHideTimer,this);this.startViewerHideTimer=__bind(this.startViewerHideTimer,this);this.showViewer=__bind(this.showViewer,this);this.onEditorSubmit=__bind(this.onEditorSubmit,this);this.onEditorHide=__bind(this.onEditorHide,this);this.showEditor=__bind(this.showEditor,this);b.__super__.constructor.apply(this,arguments);this.plugins={};if(!b.supported()){return this}if(!this.options.readOnly){this._setupDocumentEvents()}this._setupWrapper()._setupViewer()._setupEditor();this._setupDynamicStyle();this.adder=$(this.html.adder).appendTo(this.wrapper).hide();b._instances.push(this)}b.prototype._setupWrapper=function(){this.wrapper=$(this.html.wrapper);this.element.find("script").remove();this.element.wrapInner(this.wrapper);this.wrapper=this.element.find(".annotator-wrapper");return this};b.prototype._setupViewer=function(){var c=this;this.viewer=new b.Viewer({readOnly:this.options.readOnly});this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:function(e,d){if(d.text){$(e).html(Util.escape(d.text))}else{$(e).html("<i>"+(_t("No Comment"))+"</i>")}return c.publish("annotationViewerTextField",[e,d])}}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer});return this};b.prototype._setupEditor=function(){this.editor=new b.Editor();this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"textarea",label:_t("Comments")+"\u2026",load:function(d,c){return $(d).find("textarea").val(c.text||"")},submit:function(d,c){return c.text=$(d).find("textarea").val()}});this.editor.element.appendTo(this.wrapper);return this};b.prototype._setupDocumentEvents=function(){$(document).bind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection});return this};b.prototype._setupDynamicStyle=function(){var d,f,e,c;e=$("#annotator-dynamic-style");if(!e.length){e=$('<style id="annotator-dynamic-style"></style>').appendTo(document.head)}f="*"+((function(){var k,i,j,h;j=["adder","outer","notice","filter"];h=[];for(k=0,i=j.length;k<i;k++){c=j[k];h.push(":not(.annotator-"+c+")")}return h})()).join("");d=Util.maxZIndex($(document.body).find(f));d=Math.max(d,1000);e.text([".annotator-adder, .annotator-outer, .annotator-notice {","  z-index: "+(d+20)+";","}",".annotator-filter {","  z-index: "+(d+10)+";","}"].join("\n"));return this};b.prototype.destroy=function(){var c,d,e,f;$(document).unbind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection});$("#annotator-dynamic-style").remove();this.adder.remove();this.viewer.destroy();this.editor.destroy();this.wrapper.find(".annotator-hl").each(function(){$(this).contents().insertBefore(this);return $(this).remove()});this.wrapper.contents().insertBefore(this.wrapper);this.wrapper.remove();this.element.data("annotator",null);f=this.plugins;for(d in f){e=f[d];this.plugins[d].destroy()}this.removeEvents();c=b._instances.indexOf(this);if(c!==-1){return b._instances.splice(c,1)}};b.prototype.getSelectedRanges=function(){var e,j,f,c,d,l,m,h,k;m=Util.getGlobal().getSelection();d=[];l=[];if(!m.isCollapsed){d=(function(){var o,n,i;i=[];for(j=o=0,n=m.rangeCount;0<=n?o<n:o>n;j=0<=n?++o:--o){c=m.getRangeAt(j);e=new Range.BrowserRange(c);f=e.normalize().limit(this.wrapper[0]);if(f===null){l.push(c)}i.push(f)}return i}).call(this);m.removeAllRanges()}for(h=0,k=l.length;h<k;h++){c=l[h];m.addRange(c)}return $.grep(d,function(i){if(i){m.addRange(i.toRange())}return i})};b.prototype.createAnnotation=function(){var c;c={};this.publish("beforeAnnotationCreated",[c]);return c};b.prototype.setupAnnotation=function(f){var m,l,k,c,n,i,h,o,d,j;n=this.wrapper[0];f.ranges||(f.ranges=this.selectedRanges);k=[];j=f.ranges;for(i=0,o=j.length;i<o;i++){c=j[i];try{k.push(Range.sniff(c).normalize(n))}catch(p){m=p;if(m instanceof Range.RangeError){this.publish("rangeNormalizeFail",[f,c,m])}else{throw m}}}if(k.length!==0){f.quote=[];f.ranges=[];f.highlights=[];for(h=0,d=k.length;h<d;h++){l=k[h];f.quote.push($.trim(l.text()));f.ranges.push(l.serialize(this.wrapper[0],".annotator-hl"));$.merge(f.highlights,this.highlightRange(l))}f.quote=f.quote.join(" / ");$(f.highlights).data("annotation",f);}return f};b.prototype.updateAnnotation=function(c){this.publish("beforeAnnotationUpdated",[c]);this.publish("annotationUpdated",[c]);return c};b.prototype.deleteAnnotation=function(c){var j,e,i,d,f;if(c.highlights!=null){f=c.highlights;for(i=0,d=f.length;i<d;i++){e=f[i];if(!(e.parentNode!=null)){continue}j=e.childNodes[0];$(e).replaceWith(e.childNodes)}}this.publish("annotationDeleted",[c]);return c};b.prototype.loadAnnotations=function(d){var f,c,e=this;if(d==null){d=[]}c=function(j){var l,i,k,h;if(j==null){j=[]}i=j.splice(0,10);for(k=0,h=i.length;k<h;k++){l=i[k];e.setupAnnotation(l)}if(j.length>0){return setTimeout((function(){return c(j)}),10)}else{return e.publish("annotationsLoaded",[f])}};f=d.slice();if(d.length){c(d)}else{e.publish("annotationsLoaded",[f])}return this};b.prototype.dumpAnnotations=function(){if(this.plugins.Store){return this.plugins.Store.dumpAnnotations()}else{console.warn(_t("Can't dump annotations without Store plugin."));return false}};b.prototype.highlightRange=function(e,l){var c,d,j,h,k,i,f;if(l==null){l="annotator-hl"}j=/^\s*$/;c=$("<span class='"+l+"'></span>");i=e.textNodes();f=[];for(h=0,k=i.length;h<k;h++){d=i[h];if(!j.test(d.nodeValue)){f.push($(d).wrapAll(c).parent().show()[0])}}return f};b.prototype.highlightRanges=function(f,d){var i,e,h,c;if(d==null){d="annotator-hl"}i=[];for(h=0,c=f.length;h<c;h++){e=f[h];$.merge(i,this.highlightRange(e,d))}return i};b.prototype.addPlugin=function(e,d){var c,f;if(this.plugins[e]){console.error(_t("You cannot have more than one instance of any plugin."))}else{c=b.Plugin[e];if(typeof c==="function"){this.plugins[e]=new c(this.element[0],d);this.plugins[e].annotator=this;if(typeof(f=this.plugins[e]).pluginInit==="function"){f.pluginInit()}}else{console.error(_t("Could not load ")+e+_t(" plugin. Have you included the appropriate <script> tag?"))}}return this};b.prototype.showEditor=function(c,d){this.editor.element.css(d);this.editor.load(c);this.publish("annotationEditorShown",[this.editor,c]);return this};b.prototype.onEditorHide=function(){this.publish("annotationEditorHidden",[this.editor]);return this.ignoreMouseup=false};b.prototype.onEditorSubmit=function(c){return this.publish("annotationEditorSubmit",[this.editor,c])};b.prototype.showViewer=function(d,c){this.viewer.element.css(c);this.viewer.load(d);return this.publish("annotationViewerShown",[this.viewer,d])};b.prototype.startViewerHideTimer=function(){if(!this.viewerHideTimer){return this.viewerHideTimer=setTimeout(this.viewer.hide,250)}};b.prototype.clearViewerHideTimer=function(){clearTimeout(this.viewerHideTimer);return this.viewerHideTimer=false};b.prototype.checkForStartSelection=function(c){if(!(c&&this.isAnnotator(c.target))){this.startViewerHideTimer()}return this.mouseIsDown=true};b.prototype.checkForEndSelection=function(f){var d,e,i,c,h;this.mouseIsDown=false;if(this.ignoreMouseup){return}this.selectedRanges=this.getSelectedRanges();h=this.selectedRanges;for(i=0,c=h.length;i<c;i++){e=h[i];d=e.commonAncestor;if($(d).hasClass("annotator-hl")){d=$(d).parents("[class!=annotator-hl]")[0]}if(this.isAnnotator(d)){return}}if(f&&this.selectedRanges.length){return this.adder.css(Util.mousePosition(f,this.wrapper[0])).show()}else{return this.adder.hide()}};b.prototype.isAnnotator=function(c){return !!$(c).parents().andSelf().filter("[class^=annotator-]").not(this.wrapper).length};b.prototype.onHighlightMouseover=function(c){var d;this.clearViewerHideTimer();if(this.mouseIsDown||this.viewer.isShown()){return false}d=$(c.target).parents(".annotator-hl").andSelf().map(function(){return $(this).data("annotation")});return this.showViewer($.makeArray(d),Util.mousePosition(c,this.wrapper[0]))};b.prototype.onAdderMousedown=function(c){if(c!=null){c.preventDefault()}return this.ignoreMouseup=true};b.prototype.onAdderClick=function(i){var d,h,e,c,f,j=this;if(i!=null){i.preventDefault()}c=this.adder.position();this.adder.hide();d=this.setupAnnotation(this.createAnnotation());$(d.highlights).addClass("annotator-hl-temporary");f=function(){e();$(d.highlights).removeClass("annotator-hl-temporary");return j.publish("annotationCreated",[d])};h=function(){e();return j.deleteAnnotation(d)};e=function(){j.unsubscribe("annotationEditorHidden",h);return j.unsubscribe("annotationEditorSubmit",f)};this.subscribe("annotationEditorHidden",h);this.subscribe("annotationEditorSubmit",f);return this.showEditor(d,c)};b.prototype.onEditAnnotation=function(c){var d,e,h,f=this;e=this.viewer.element.position();h=function(){d();return f.updateAnnotation(c)};d=function(){f.unsubscribe("annotationEditorHidden",d);return f.unsubscribe("annotationEditorSubmit",h)};this.subscribe("annotationEditorHidden",d);this.subscribe("annotationEditorSubmit",h);this.viewer.hide();return this.showEditor(c,e)};b.prototype.onDeleteAnnotation=function(c){this.viewer.hide();return this.deleteAnnotation(c)};return b})(Delegator);Annotator.Plugin=(function(b){__extends(a,b);function a(d,c){a.__super__.constructor.apply(this,arguments)}a.prototype.pluginInit=function(){};a.prototype.destroy=function(){return this.removeEvents()};return a})(Delegator);g=Util.getGlobal();if(((_ref=g.document)!=null?_ref.evaluate:void 0)==null){$.getScript("http://assets.annotateit.org/vendor/xpath.min.js")}if(g.getSelection==null){$.getScript("http://assets.annotateit.org/vendor/ierange.min.js")}if(g.JSON==null){$.getScript("http://assets.annotateit.org/vendor/json2.min.js")}if(g.Node==null){g.Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12}}Annotator.$=$;Annotator.Delegator=Delegator;Annotator.Range=Range;Annotator.Util=Util;Annotator._instances=[];Annotator._t=_t;Annotator.supported=function(){return(function(){return !!this.getSelection})()};Annotator.noConflict=function(){Util.getGlobal().Annotator=_Annotator;return this};$.fn.annotator=function(b){var a;a=Array.prototype.slice.call(arguments,1);return this.each(function(){var c;c=$.data(this,"annotator");if(c){return b&&c[b].apply(c,a)}else{c=new Annotator(this,b);return $.data(this,"annotator",c)}})};this.Annotator=Annotator;var __hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Annotator.Widget=(function(b){__extends(a,b);a.prototype.classes={hide:"annotator-hide",invert:{x:"annotator-invert-x",y:"annotator-invert-y"}};function a(d,c){a.__super__.constructor.apply(this,arguments);this.classes=$.extend({},Annotator.Widget.prototype.classes,this.classes)}a.prototype.destroy=function(){this.removeEvents();return this.element.remove()};a.prototype.checkOrientation=function(){var f,h,c,e,d;this.resetOrientation();d=$(Annotator.Util.getGlobal());e=this.element.children(":first");h=e.offset();c={top:d.scrollTop(),right:d.width()+d.scrollLeft()};f={top:h.top,right:h.left+e.width()};if((f.top-c.top)<0){this.invertY()}if((f.right-c.right)>0){this.invertX()}return this};a.prototype.resetOrientation=function(){this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y);return this};a.prototype.invertX=function(){this.element.addClass(this.classes.invert.x);return this};a.prototype.invertY=function(){this.element.addClass(this.classes.invert.y);return this};a.prototype.isInvertedY=function(){return this.element.hasClass(this.classes.invert.y)};a.prototype.isInvertedX=function(){return this.element.hasClass(this.classes.invert.x)};return a})(Delegator);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Annotator.Editor=(function(b){__extends(a,b);a.prototype.events={"form submit":"submit",".annotator-save click":"submit",".annotator-cancel click":"hide",".annotator-cancel mouseover":"onCancelButtonMouseover","textarea keydown":"processKeypress"};a.prototype.classes={hide:"annotator-hide",focus:"annotator-focus"};a.prototype.html='<div class="annotator-outer annotator-editor">\n  <form class="annotator-widget">\n    <ul class="annotator-listing"></ul>\n    <div class="annotator-controls">\n      <a href="#cancel" class="annotator-cancel">'+_t("Cancel")+'</a>\n<a href="#save" class="annotator-save annotator-focus">'+_t("Save")+"</a>\n    </div>\n  </form>\n</div>";a.prototype.options={};function a(c){this.onCancelButtonMouseover=__bind(this.onCancelButtonMouseover,this);this.processKeypress=__bind(this.processKeypress,this);this.submit=__bind(this.submit,this);this.load=__bind(this.load,this);this.hide=__bind(this.hide,this);this.show=__bind(this.show,this);a.__super__.constructor.call(this,$(this.html)[0],c);this.fields=[];this.annotation={}}a.prototype.show=function(c){Annotator.Util.preventEventDefault(c);this.element.removeClass(this.classes.hide);this.element.find(".annotator-save").addClass(this.classes.focus);this.checkOrientation();this.element.find(":input:first").focus();this.setupDraggables();return this.publish("show")};a.prototype.hide=function(c){Annotator.Util.preventEventDefault(c);this.element.addClass(this.classes.hide);return this.publish("hide")};a.prototype.load=function(c){var h,f,d,e;this.annotation=c;this.publish("load",[this.annotation]);e=this.fields;for(f=0,d=e.length;f<d;f++){h=e[f];h.load(h.element,this.annotation)}return this.show()};a.prototype.submit=function(d){var h,f,c,e;Annotator.Util.preventEventDefault(d);e=this.fields;for(f=0,c=e.length;f<c;f++){h=e[f];h.submit(h.element,this.annotation)}this.publish("save",[this.annotation]);return this.hide()};a.prototype.addField=function(d){var e,f,c;f=$.extend({id:"annotator-field-"+Annotator.Util.uuid(),type:"input",label:"",load:function(){},submit:function(){}},d);c=null;e=$('<li class="annotator-item" />');f.element=e[0];switch(f.type){case"textarea":c=$("<textarea />");break;case"input":case"checkbox":c=$("<input />");break;case"select":c=$("<select />")}e.append(c);c.attr({id:f.id,placeholder:f.label});if(f.type==="checkbox"){c[0].type="checkbox";e.addClass("annotator-checkbox");e.append($("<label />",{"for":f.id,html:f.label}))}this.element.find("ul:first").append(e);this.fields.push(f);return f.element};a.prototype.checkOrientation=function(){var c,d;a.__super__.checkOrientation.apply(this,arguments);d=this.element.find("ul");c=this.element.find(".annotator-controls");if(this.element.hasClass(this.classes.invert.y)){c.insertBefore(d)}else{if(c.is(":first-child")){c.insertAfter(d)}}return this};a.prototype.processKeypress=function(c){if(c.keyCode===27){return this.hide()}else{if(c.keyCode===13&&!c.shiftKey){return this.submit()}}};a.prototype.onCancelButtonMouseover=function(){return this.element.find("."+this.classes.focus).removeClass(this.classes.focus)};a.prototype.setupDraggables=function(){var f,o,e,k,c,i,m,h,d,l,n,j=this;this.element.find(".annotator-resize").remove();if(this.element.hasClass(this.classes.invert.y)){e=this.element.find(".annotator-item:last")}else{e=this.element.find(".annotator-item:first")}if(e){$('<span class="annotator-resize"></span>').appendTo(e)}c=null;f=this.classes;k=this.element;l=null;d=k.find(".annotator-resize");o=k.find(".annotator-controls");n=false;i=function(p){if(p.target===this){c={element:this,top:p.pageY,left:p.pageX};l=k.find("textarea:first");$(window).bind({"mouseup.annotator-editor-resize":h,"mousemove.annotator-editor-resize":m});return p.preventDefault()}};h=function(){c=null;return $(window).unbind(".annotator-editor-resize")};m=function(t){var u,r,q,p,s;if(c&&n===false){u={top:t.pageY-c.top,left:t.pageX-c.left};if(c.element===d[0]){p=l.outerHeight();s=l.outerWidth();r=k.hasClass(f.invert.x)?-1:1;q=k.hasClass(f.invert.y)?1:-1;l.height(p+(u.top*q));l.width(s+(u.left*r));if(l.outerHeight()!==p){c.top=t.pageY}if(l.outerWidth()!==s){c.left=t.pageX}}else{if(c.element===o[0]){k.css({top:parseInt(k.css("top"),10)+u.top,left:parseInt(k.css("left"),10)+u.left});c.top=t.pageY;c.left=t.pageX}}n=true;return setTimeout(function(){return n=false},1000/60)}};d.bind("mousedown",i);return o.bind("mousedown",i)};return a})(Annotator.Widget);var LinkParser,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Annotator.Viewer=(function(a){__extends(b,a);b.prototype.events={".annotator-edit click":"onEditClick",".annotator-delete click":"onDeleteClick"};b.prototype.classes={hide:"annotator-hide",showControls:"annotator-visible"};b.prototype.html={element:'<div class="annotator-outer annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>',item:'<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <a href="#" title="View as webpage" class="annotator-link">View as webpage</a>\n    <button title="Edit" class="annotator-edit">Edit</button>\n    <button title="Delete" class="annotator-delete">Delete</button>\n  </span>\n</li>'};b.prototype.options={readOnly:false};function b(c){this.onDeleteClick=__bind(this.onDeleteClick,this);this.onEditClick=__bind(this.onEditClick,this);this.load=__bind(this.load,this);this.hide=__bind(this.hide,this);this.show=__bind(this.show,this);b.__super__.constructor.call(this,$(this.html.element)[0],c);this.item=$(this.html.item)[0];this.fields=[];this.annotations=[]}b.prototype.show=function(d){var c,e=this;Annotator.Util.preventEventDefault(d);c=this.element.find(".annotator-controls").addClass(this.classes.showControls);setTimeout((function(){return c.removeClass(e.classes.showControls)}),500);this.element.removeClass(this.classes.hide);return this.checkOrientation().publish("show")};b.prototype.isShown=function(){return !this.element.hasClass(this.classes.hide)};b.prototype.hide=function(c){Annotator.Util.preventEventDefault(c);this.element.addClass(this.classes.hide);return this.publish("hide")};b.prototype.load=function(c){var k,p,o,m,q,h,d,s,l,f,r,i,e,t,u,n,j;this.annotations=c||[];r=this.element.find("ul:first").empty();n=this.annotations;for(i=0,t=n.length;i<t;i++){k=n[i];s=$(this.item).clone().appendTo(r).data("annotation",k);o=s.find(".annotator-controls");l=o.find(".annotator-link");q=o.find(".annotator-edit");m=o.find(".annotator-delete");f=new LinkParser(k.links||[]).get("alternate",{type:"text/html"});if(f.length===0||(f[0].href==null)){l.remove()}else{l.attr("href",f[0].href)}if(this.options.readOnly){q.remove();m.remove()}else{p={showEdit:function(){return q.removeAttr("disabled")},hideEdit:function(){return q.attr("disabled","disabled")},showDelete:function(){return m.removeAttr("disabled")},hideDelete:function(){return m.attr("disabled","disabled")}}}j=this.fields;for(e=0,u=j.length;e<u;e++){d=j[e];h=$(d.element).clone().appendTo(s)[0];d.load(h,k,p)}}this.publish("load",[this.annotations]);return this.show()};b.prototype.addField=function(c){var d;d=$.extend({load:function(){}},c);d.element=$("<div />")[0];this.fields.push(d);d.element;return this};b.prototype.onEditClick=function(c){return this.onButtonClick(c,"edit")};b.prototype.onDeleteClick=function(c){return this.onButtonClick(c,"delete")};b.prototype.onButtonClick=function(e,c){var d;d=$(e.target).parents(".annotator-annotation");return this.publish(c,[d.data("annotation")])};return b})(Annotator.Widget);LinkParser=(function(){function a(b){this.data=b}a.prototype.get=function(o,j){var i,c,n,h,m,e,l,f,b;if(j==null){j={}}j=$.extend({},j,{rel:o});n=(function(){var d;d=[];for(c in j){if(!__hasProp.call(j,c)){continue}m=j[c];d.push(c)}return d})();f=this.data;b=[];for(e=0,l=f.length;e<l;e++){i=f[e];h=n.reduce((function(d,p){return d&&(i[p]===j[p])}),true);if(h){b.push(i)}else{continue}}return b};return a})();var Annotator,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Annotator=Annotator||{};Annotator.Notification=(function(a){__extends(b,a);b.prototype.events={click:"hide"};b.prototype.options={html:"<div class='annotator-notice'></div>",classes:{show:"annotator-notice-show",info:"annotator-notice-info",success:"annotator-notice-success",error:"annotator-notice-error"}};function b(c){this.hide=__bind(this.hide,this);this.show=__bind(this.show,this);b.__super__.constructor.call(this,$(this.options.html).appendTo(document.body)[0],c)}b.prototype.show=function(d,c){if(c==null){c=Annotator.Notification.INFO}$(this.element).addClass(this.options.classes.show).addClass(this.options.classes[c]).html(Util.escape(d||""));setTimeout(this.hide,5000);return this};b.prototype.hide=function(){$(this.element).removeClass(this.options.classes.show);return this};return b})(Delegator);Annotator.Notification.INFO="show";Annotator.Notification.SUCCESS="success";Annotator.Notification.ERROR="error";$(function(){var a;a=new Annotator.Notification;Annotator.showNotification=a.show;return Annotator.hideNotification=a.hide});var _ref,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Annotator.Plugin.Unsupported=(function(a){__extends(b,a);function b(){_ref=b.__super__.constructor.apply(this,arguments);return _ref}b.prototype.options={message:Annotator._t("Sorry your current browser does not support the Annotator")};b.prototype.pluginInit=function(){var c=this;if(!Annotator.supported()){return $(function(){Annotator.showNotification(c.options.message);if((window.XMLHttpRequest===void 0)&&(ActiveXObject!==void 0)){return $("html").addClass("ie6")}})}};return b})(Annotator.Plugin);var base64Decode,base64UrlDecode,createDateFromISO8601,parseToken,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};createDateFromISO8601=function(b){var i,a,h,e,f,c;e="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\\.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?";i=b.match(new RegExp(e));h=0;a=new Date(i[1],0,1);if(i[3]){a.setMonth(i[3]-1)}if(i[5]){a.setDate(i[5])}if(i[7]){a.setHours(i[7])}if(i[8]){a.setMinutes(i[8])}if(i[10]){a.setSeconds(i[10])}if(i[12]){a.setMilliseconds(Number("0."+i[12])*1000)}if(i[14]){h=(Number(i[16])*60)+Number(i[17]);h*=(c=i[15]==="-")!=null?c:{1:-1}}h-=a.getTimezoneOffset();f=Number(a)+(h*60*1000);a.setTime(Number(f));return a};base64Decode=function(j){var p,d,o,e,n,m,l,k,h,c,b,a,f;if(typeof atob!=="undefined"&&atob!==null){return atob(j)}else{d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";h=0;p=0;e="";f=[];if(!j){return j}j+="";while(h<j.length){n=d.indexOf(j.charAt(h++));m=d.indexOf(j.charAt(h++));l=d.indexOf(j.charAt(h++));k=d.indexOf(j.charAt(h++));o=n<<18|m<<12|l<<6|k;c=o>>16&255;b=o>>8&255;a=o&255;if(l===64){f[p++]=String.fromCharCode(c)}else{if(k===64){f[p++]=String.fromCharCode(c,b)}else{f[p++]=String.fromCharCode(c,b,a)}}}return f.join("")}};base64UrlDecode=function(e){var b,a,d,c;a=e.length%4;if(a!==0){for(b=d=0,c=4-a;0<=c?d<c:d>c;b=0<=c?++d:--d){e+="="}}e=e.replace(/-/g,"+");e=e.replace(/_/g,"/");return base64Decode(e)};parseToken=function(b){var a,d,e,c;c=b.split("."),a=c[0],d=c[1],e=c[2];return JSON.parse(base64UrlDecode(d))};Annotator.Plugin.Auth=(function(b){__extends(a,b);a.prototype.options={token:null,tokenUrl:"/auth/token",autoFetch:true};function a(d,c){a.__super__.constructor.apply(this,arguments);this.waitingForToken=[];if(this.options.token){this.setToken(this.options.token)}else{this.requestToken()}}a.prototype.requestToken=function(){var c=this;this.requestInProgress=true;return $.ajax({url:this.options.tokenUrl,dataType:"text",xhrFields:{withCredentials:true}}).done(function(e,d,f){return c.setToken(e)}).fail(function(h,d,e){var f;f=Annotator._t("Couldn't get auth token:");console.error(""+f+" "+e,h);return Annotator.showNotification(""+f+" "+h.responseText,Annotator.Notification.ERROR)}).always(function(){return c.requestInProgress=false})};a.prototype.setToken=function(d){var c,e=this;this.token=d;this._unsafeToken=parseToken(d);if(this.haveValidToken()){if(this.options.autoFetch){this.refreshTimeout=setTimeout((function(){return e.requestToken()}),(this.timeToExpiry()-2)*1000)}this.updateHeaders();c=[];while(this.waitingForToken.length>0){c.push(this.waitingForToken.pop()(this._unsafeToken))}return c}else{console.warn(Annotator._t("Didn't get a valid token."));if(this.options.autoFetch){console.warn(Annotator._t("Getting a new token in 10s."));return setTimeout((function(){return e.requestToken()}),10*1000)}}};a.prototype.haveValidToken=function(){var c;c=this._unsafeToken&&this._unsafeToken.issuedAt&&this._unsafeToken.ttl&&this._unsafeToken.consumerKey;if(c&&this.timeToExpiry()>0){return true}else{return false}};a.prototype.timeToExpiry=function(){var e,c,d,f;d=new Date().getTime()/1000;c=createDateFromISO8601(this._unsafeToken.issuedAt).getTime()/1000;e=c+this._unsafeToken.ttl;f=e-d;if(f>0){return f}else{return 0}};a.prototype.updateHeaders=function(){var c;c=this.element.data("annotator:headers");return this.element.data("annotator:headers",$.extend(c,{"x-annotator-auth-token":this.token}))};a.prototype.withToken=function(c){if(c==null){return}if(this.haveValidToken()){return c(this._unsafeToken)}else{this.waitingForToken.push(c);if(!this.requestInProgress){return this.requestToken()}}};return a})(Annotator.Plugin);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d},__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};Annotator.Plugin.Store=(function(a){__extends(b,a);b.prototype.events={annotationCreated:"annotationCreated",annotationDeleted:"annotationDeleted",annotationUpdated:"annotationUpdated"};b.prototype.options={annotationData:{},emulateHTTP:false,loadFromSearch:false,prefix:"/store",urls:{create:"/annotations",read:"/annotations/:id",update:"/annotations/:id",destroy:"/annotations/:id",search:"/search"}};function b(d,c){this._onError=__bind(this._onError,this);this._onLoadAnnotationsFromSearch=__bind(this._onLoadAnnotationsFromSearch,this);this._onLoadAnnotations=__bind(this._onLoadAnnotations,this);this._getAnnotations=__bind(this._getAnnotations,this);b.__super__.constructor.apply(this,arguments);this.annotations=[]}b.prototype.pluginInit=function(){if(!Annotator.supported()){return}if(this.annotator.plugins.Auth){return this.annotator.plugins.Auth.withToken(this._getAnnotations)}else{return this._getAnnotations()}};b.prototype._getAnnotations=function(){if(this.options.loadFromSearch){return this.loadAnnotationsFromSearch(this.options.loadFromSearch)}else{return this.loadAnnotations()}};b.prototype.annotationCreated=function(c){var d=this;if(__indexOf.call(this.annotations,c)<0){this.registerAnnotation(c);return this._apiRequest("create",c,function(e){if(e.id==null){console.warn(Annotator._t("Warning: No ID returned from server for annotation "),c)}return d.updateAnnotation(c,e)})}else{return this.updateAnnotation(c,{})}};b.prototype.annotationUpdated=function(c){var d=this;if(__indexOf.call(this.annotations,c)>=0){return this._apiRequest("update",c,(function(e){return d.updateAnnotation(c,e)}))}};b.prototype.annotationDeleted=function(c){var d=this;if(__indexOf.call(this.annotations,c)>=0){return this._apiRequest("destroy",c,(function(){return d.unregisterAnnotation(c)}))}};b.prototype.registerAnnotation=function(c){return this.annotations.push(c)};b.prototype.unregisterAnnotation=function(c){return this.annotations.splice(this.annotations.indexOf(c),1)};b.prototype.updateAnnotation=function(c,d){if(__indexOf.call(this.annotations,c)<0){console.error(Annotator._t("Trying to update unregistered annotation!"))}else{$.extend(c,d)}return $(c.highlights).data("annotation",c)};b.prototype.loadAnnotations=function(){return this._apiRequest("read",null,this._onLoadAnnotations)};b.prototype._onLoadAnnotations=function(i){var k,d,j,m,f,e,l,c,h;if(i==null){i=[]}j={};h=this.annotations;for(f=0,l=h.length;f<l;f++){k=h[f];j[k.id]=k}m=[];for(e=0,c=i.length;e<c;e++){k=i[e];if(j[k.id]){d=j[k.id];this.updateAnnotation(d,k)}else{m.push(k)}}this.annotations=this.annotations.concat(m);return this.annotator.loadAnnotations(m.slice())};b.prototype.loadAnnotationsFromSearch=function(c){return this._apiRequest("search",c,this._onLoadAnnotationsFromSearch)};b.prototype._onLoadAnnotationsFromSearch=function(c){if(c==null){c={}}return this._onLoadAnnotations(c.rows||[])};b.prototype.dumpAnnotations=function(){var h,f,d,e,c;e=this.annotations;c=[];for(f=0,d=e.length;f<d;f++){h=e[f];c.push(JSON.parse(this._dataFor(h)))}return c};b.prototype._apiRequest=function(f,h,i){var j,d,e,c;j=h&&h.id;c=this._urlFor(f,j);d=this._apiRequestOptions(f,h,i);e=$.ajax(c,d);e._id=j;e._action=f;return e};b.prototype._apiRequestOptions=function(e,f,h){var d,i,c;i=this._methodFor(e);c={type:i,headers:this.element.data("annotator:headers"),dataType:"json",success:h||function(){},error:this._onError};if(this.options.emulateHTTP&&(i==="PUT"||i==="DELETE")){c.headers=$.extend(c.headers,{"X-HTTP-Method-Override":i});c.type="POST"}if(e==="search"){c=$.extend(c,{data:f});return c}d=f&&this._dataFor(f);if(this.options.emulateJSON){c.data={json:d};if(this.options.emulateHTTP){c.data._method=i}return c}c=$.extend(c,{data:d,contentType:"application/json; charset=utf-8"});return c};b.prototype._urlFor=function(d,e){var c;c=this.options.prefix!=null?this.options.prefix:"";c+=this.options.urls[d];c=c.replace(/\/:id/,e!=null?"/"+e:"");c=c.replace(/:id/,e!=null?e:"");return c};b.prototype._methodFor=function(d){var c;c={create:"POST",read:"GET",update:"PUT",destroy:"DELETE",search:"GET"};return c[d]};b.prototype._dataFor=function(c){var d,e;e=c.highlights;delete c.highlights;$.extend(c,this.options.annotationData);d=JSON.stringify(c);if(e){c.highlights=e}return d};b.prototype._onError=function(e){var d,c;d=e._action;c=Annotator._t("Sorry we could not ")+d+Annotator._t(" this annotation");if(e._action==="search"){c=Annotator._t("Sorry we could not search the store for annotations")}else{if(e._action==="read"&&!e._id){c=Annotator._t("Sorry we could not ")+d+Annotator._t(" the annotations from the store")}}switch(e.status){case 401:c=Annotator._t("Sorry you are not allowed to ")+d+Annotator._t(" this annotation");break;case 404:c=Annotator._t("Sorry we could not connect to the annotations store");break;case 500:c=Annotator._t("Sorry something went wrong with the annotation store")}Annotator.showNotification(c,Annotator.Notification.ERROR);return console.error(Annotator._t("API request failed:")+(" '"+e.status+"'"))};return b})(Annotator.Plugin);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Annotator.Plugin.Permissions=(function(a){__extends(b,a);b.prototype.events={beforeAnnotationCreated:"addFieldsToAnnotation"};b.prototype.options={showViewPermissionsCheckbox:true,showEditPermissionsCheckbox:true,userId:function(c){return c},userString:function(c){return c},userAuthorize:function(i,c,e){var f,j,h,d;if(c.permissions){j=c.permissions[i]||[];if(j.length===0){return true}for(h=0,d=j.length;h<d;h++){f=j[h];if(this.userId(e)===f){return true}}return false}else{if(c.user){if(e){return this.userId(e)===this.userId(c.user)}else{return false}}}return true},user:"",permissions:{read:[],update:[],"delete":[],admin:[]}};function b(d,c){this._setAuthFromToken=__bind(this._setAuthFromToken,this);this.updateViewer=__bind(this.updateViewer,this);this.updateAnnotationPermissions=__bind(this.updateAnnotationPermissions,this);this.updatePermissionsField=__bind(this.updatePermissionsField,this);this.addFieldsToAnnotation=__bind(this.addFieldsToAnnotation,this);b.__super__.constructor.apply(this,arguments);if(this.options.user){this.setUser(this.options.user);delete this.options.user}}b.prototype.pluginInit=function(){var c,d,e=this;if(!Annotator.supported()){return}d=this;c=function(h,f){return function(j,i){return d[h].call(d,f,j,i)}};if(!this.user&&this.annotator.plugins.Auth){this.annotator.plugins.Auth.withToken(this._setAuthFromToken)}if(this.options.showViewPermissionsCheckbox===true){this.annotator.editor.addField({type:"checkbox",label:Annotator._t("Allow anyone to <strong>view</strong> this annotation"),load:c("updatePermissionsField","read"),submit:c("updateAnnotationPermissions","read")})}if(this.options.showEditPermissionsCheckbox===true){this.annotator.editor.addField({type:"checkbox",label:Annotator._t("Allow anyone to <strong>edit</strong> this annotation"),load:c("updatePermissionsField","update"),submit:c("updateAnnotationPermissions","update")})}this.annotator.viewer.addField({load:this.updateViewer});if(this.annotator.plugins.Filter){return this.annotator.plugins.Filter.addFilter({label:Annotator._t("User"),property:"user",isFiltered:function(j,i){var h,l,f,k;i=e.options.userString(i);if(!(j&&i)){return false}k=j.split(/\s*/);for(l=0,f=k.length;l<f;l++){h=k[l];if(i.indexOf(h)===-1){return false}}return true}})}};b.prototype.setUser=function(c){return this.user=c};b.prototype.addFieldsToAnnotation=function(c){if(c){c.permissions=this.options.permissions;if(this.user){return c.user=this.user}}};b.prototype.authorize=function(e,c,d){if(d===void 0){d=this.user}if(this.options.userAuthorize){return this.options.userAuthorize.call(this.options,e,c,d)}else{return true}};b.prototype.updatePermissionsField=function(e,f,c){var d;f=$(f).show();d=f.find("input").removeAttr("disabled");if(!this.authorize("admin",c)){f.hide()}if(this.authorize(e,c||{},null)){return d.attr("checked","checked")}else{return d.removeAttr("checked")}};b.prototype.updateAnnotationPermissions=function(d,e,c){var f;if(!c.permissions){c.permissions=this.options.permissions}f=d+"-permissions";if($(e).find("input").is(":checked")){return c.permissions[d]=[]}else{return c.permissions[d]=[this.user]}};b.prototype.updateViewer=function(f,c,e){var d,h;f=$(f);h=this.options.userString(c.user);if(c.user&&h&&typeof h==="string"){d=Annotator.Util.escape(this.options.userString(c.user));f.html(d).addClass("annotator-user")}else{f.remove()}if(e){if(!this.authorize("update",c)){e.hideEdit()}if(!this.authorize("delete",c)){return e.hideDelete()}}};b.prototype._setAuthFromToken=function(c){return this.setUser(c.userId)};return b})(Annotator.Plugin);var _ref,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d},__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};Annotator.Plugin.AnnotateItPermissions=(function(a){__extends(b,a);function b(){this._setAuthFromToken=__bind(this._setAuthFromToken,this);this.updateAnnotationPermissions=__bind(this.updateAnnotationPermissions,this);this.updatePermissionsField=__bind(this.updatePermissionsField,this);this.addFieldsToAnnotation=__bind(this.addFieldsToAnnotation,this);_ref=b.__super__.constructor.apply(this,arguments);return _ref}b.prototype.options={showViewPermissionsCheckbox:true,showEditPermissionsCheckbox:true,groups:{world:"group:__world__",authenticated:"group:__authenticated__",consumer:"group:__consumer__"},userId:function(c){return c.userId},userString:function(c){return c.userId},userAuthorize:function(h,f,j){var k,l,i,e,d,c;l=f.permissions||{};k=l[h]||[];if(i=this.groups.world,__indexOf.call(k,i)>=0){return true}else{if((j!=null)&&(j.userId!=null)&&(j.consumerKey!=null)){if(j.userId===f.user&&j.consumerKey===f.consumer){return true}else{if(e=this.groups.authenticated,__indexOf.call(k,e)>=0){return true}else{if(j.consumerKey===f.consumer&&(d=this.groups.consumer,__indexOf.call(k,d)>=0)){return true}else{if(j.consumerKey===f.consumer&&(c=j.userId,__indexOf.call(k,c)>=0)){return true}else{if(j.consumerKey===f.consumer&&j.admin){return true}else{return false}}}}}}else{return false}}},permissions:{read:["group:__world__"],update:[],"delete":[],admin:[]}};b.prototype.addFieldsToAnnotation=function(c){if(c){c.permissions=this.options.permissions;if(this.user){c.user=this.user.userId;return c.consumer=this.user.consumerKey}}};b.prototype.updatePermissionsField=function(e,f,c){var d;f=$(f).show();d=f.find("input").removeAttr("disabled");if(!this.authorize("admin",c)){f.hide()}if(this.user&&this.authorize(e,c||{},{userId:"__nonexistentuser__",consumerKey:this.user.consumerKey})){return d.attr("checked","checked")}else{return d.removeAttr("checked")}};b.prototype.updateAnnotationPermissions=function(d,e,c){var f;if(!c.permissions){c.permissions=this.options.permissions}f=d+"-permissions";if($(e).find("input").is(":checked")){return c.permissions[d]=[d==="read"?this.options.groups.world:this.options.groups.consumer]}else{return c.permissions[d]=[]}};b.prototype._setAuthFromToken=function(c){return this.setUser(c)};return b})(Annotator.Plugin.Permissions);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Annotator.Plugin.Filter=(function(b){__extends(a,b);a.prototype.events={".annotator-filter-property input focus":"_onFilterFocus",".annotator-filter-property input blur":"_onFilterBlur",".annotator-filter-property input keyup":"_onFilterKeyup",".annotator-filter-previous click":"_onPreviousClick",".annotator-filter-next click":"_onNextClick",".annotator-filter-clear click":"_onClearClick"};a.prototype.classes={active:"annotator-filter-active",hl:{hide:"annotator-hl-filtered",active:"annotator-hl-active"}};a.prototype.html={element:'<div class="annotator-filter">\n  <strong>'+Annotator._t("Navigate:")+'</strong>\n<span class="annotator-filter-navigation">\n  <button class="annotator-filter-previous">'+Annotator._t("Previous")+'</button>\n<button class="annotator-filter-next">'+Annotator._t("Next")+"</button>\n</span>\n<strong>"+Annotator._t("Filter by:")+"</strong>\n</div>",filter:'<span class="annotator-filter-property">\n  <label></label>\n  <input/>\n  <button class="annotator-filter-clear">'+Annotator._t("Clear")+"</button>\n</span>"};a.prototype.options={appendTo:"body",filters:[],addAnnotationFilter:true,isFiltered:function(e,i){var d,h,c,f;if(!(e&&i)){return false}f=e.split(/\s*/);for(h=0,c=f.length;h<c;h++){d=f[h];if(i.indexOf(d)===-1){return false}}return true}};function a(d,c){this._onPreviousClick=__bind(this._onPreviousClick,this);this._onNextClick=__bind(this._onNextClick,this);this._onFilterKeyup=__bind(this._onFilterKeyup,this);this._onFilterBlur=__bind(this._onFilterBlur,this);this._onFilterFocus=__bind(this._onFilterFocus,this);this.updateHighlights=__bind(this.updateHighlights,this);var e;d=$(this.html.element).appendTo((c!=null?c.appendTo:void 0)||this.options.appendTo);a.__super__.constructor.call(this,d,c);(e=this.options).filters||(e.filters=[]);this.filter=$(this.html.filter);this.filters=[];this.current=0}a.prototype.pluginInit=function(){var d,f,c,e;e=this.options.filters;for(f=0,c=e.length;f<c;f++){d=e[f];this.addFilter(d)}this.updateHighlights();this._setupListeners()._insertSpacer();if(this.options.addAnnotationFilter===true){return this.addFilter({label:Annotator._t("Annotation"),property:"text"})}};a.prototype.destroy=function(){var d,c;a.__super__.destroy.apply(this,arguments);c=$("html");d=parseInt(c.css("padding-top"),10)||0;c.css("padding-top",d-this.element.outerHeight());return this.element.remove()};a.prototype._insertSpacer=function(){var d,c;c=$("html");d=parseInt(c.css("padding-top"),10)||0;c.css("padding-top",d+this.element.outerHeight());return this};a.prototype._setupListeners=function(){var e,d,f,c;d=["annotationsLoaded","annotationCreated","annotationUpdated","annotationDeleted"];for(f=0,c=d.length;f<c;f++){e=d[f];this.annotator.subscribe(e,this.updateHighlights)}return this};a.prototype.addFilter=function(c){var e,d;d=$.extend({label:"",property:"",isFiltered:this.options.isFiltered},c);if(!((function(){var j,h,i,f;i=this.filters;f=[];for(j=0,h=i.length;j<h;j++){e=i[j];if(e.property===d.property){f.push(e)}}return f}).call(this)).length){d.id="annotator-filter-"+d.property;d.annotations=[];d.element=this.filter.clone().appendTo(this.element);d.element.find("label").html(d.label).attr("for",d.id);d.element.find("input").attr({id:d.id,placeholder:Annotator._t("Filter by ")+d.label+"\u2026"});d.element.find("button").hide();d.element.data("filter",d);this.filters.push(d)}return this};a.prototype.updateFilter=function(f){var c,k,e,j,i,d,h;f.annotations=[];this.updateHighlights();this.resetHighlights();e=$.trim(f.element.find("input").val());if(e){k=this.highlights.map(function(){return $(this).data("annotation")});h=$.makeArray(k);for(i=0,d=h.length;i<d;i++){c=h[i];j=c[f.property];if(f.isFiltered(e,j)){f.annotations.push(c)}}return this.filterHighlights()}};a.prototype.updateHighlights=function(){this.highlights=this.annotator.element.find(".annotator-hl:visible");return this.filtered=this.highlights.not(this.classes.hl.hide)};a.prototype.filterHighlights=function(){var c,d,h,k,i,j,m,e,l,f;c=$.grep(this.filters,function(n){return !!n.annotations.length});k=((f=c[0])!=null?f.annotations:void 0)||[];if(c.length>1){h=[];$.each(c,function(){return $.merge(h,this.annotations)});m=[];k=[];$.each(h,function(){if($.inArray(this,m)===-1){return m.push(this)}else{return k.push(this)}})}i=this.highlights;for(j=e=0,l=k.length;e<l;j=++e){d=k[j];i=i.not(d.highlights)}i.addClass(this.classes.hl.hide);this.filtered=this.highlights.not(this.classes.hl.hide);return this};a.prototype.resetHighlights=function(){this.highlights.removeClass(this.classes.hl.hide);this.filtered=this.highlights;return this};a.prototype._onFilterFocus=function(d){var c;c=$(d.target);c.parent().addClass(this.classes.active);return c.next("button").show()};a.prototype._onFilterBlur=function(d){var c;if(!d.target.value){c=$(d.target);c.parent().removeClass(this.classes.active);return c.next("button").hide()}};a.prototype._onFilterKeyup=function(d){var c;c=$(d.target).parent().data("filter");if(c){return this.updateFilter(c)}};a.prototype._findNextHighlight=function(i){var d,e,k,j,h,f,c,l;if(!this.highlights.length){return this}f=i?0:-1;l=i?-1:0;c=i?"lt":"gt";d=this.highlights.not("."+this.classes.hl.hide);k=d.filter("."+this.classes.hl.active);if(!k.length){k=d.eq(f)}e=k.data("annotation");j=d.index(k[0]);h=d.filter(":"+c+"("+j+")").not(e.highlights).eq(l);if(!h.length){h=d.eq(l)}return this._scrollToHighlight(h.data("annotation").highlights)};a.prototype._onNextClick=function(c){return this._findNextHighlight()};a.prototype._onPreviousClick=function(c){return this._findNextHighlight(true)};a.prototype._scrollToHighlight=function(c){c=$(c);this.highlights.removeClass(this.classes.hl.active);c.addClass(this.classes.hl.active);return $("html, body").animate({scrollTop:c.offset().top-(this.element.height()+20)},150)};a.prototype._onClearClick=function(c){return $(c.target).prev("input").val("").keyup().blur()};return a})(Annotator.Plugin);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Annotator.Plugin.Markdown=(function(b){__extends(a,b);a.prototype.events={annotationViewerTextField:"updateTextField"};function a(d,c){this.updateTextField=__bind(this.updateTextField,this);if((typeof Showdown!=="undefined"&&Showdown!==null?Showdown.converter:void 0)!=null){a.__super__.constructor.apply(this,arguments);this.converter=new Showdown.converter()}else{console.error(Annotator._t("To use the Markdown plugin, you must include Showdown into the page first."))}}a.prototype.updateTextField=function(d,c){var e;e=Annotator.Util.escape(c.text||"");return $(d).html(this.convert(e))};a.prototype.convert=function(c){return this.converter.makeHtml(c)};return a})(Annotator.Plugin);var _ref,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Annotator.Plugin.Tags=(function(b){__extends(a,b);function a(){this.setAnnotationTags=__bind(this.setAnnotationTags,this);this.updateField=__bind(this.updateField,this);_ref=a.__super__.constructor.apply(this,arguments);return _ref}a.prototype.options={parseTags:function(d){var c;d=$.trim(d);c=[];if(d){c=d.split(/\s+/)}return c},stringifyTags:function(c){return c.join(" ")}};a.prototype.field=null;a.prototype.input=null;a.prototype.pluginInit=function(){if(!Annotator.supported()){return}this.field=this.annotator.editor.addField({label:Annotator._t("Add some tags here")+"\u2026",load:this.updateField,submit:this.setAnnotationTags});this.annotator.viewer.addField({load:this.updateViewer});if(this.annotator.plugins.Filter){this.annotator.plugins.Filter.addFilter({label:Annotator._t("Tag"),property:"tags",isFiltered:Annotator.Plugin.Tags.filterCallback})}return this.input=$(this.field).find(":input")};a.prototype.parseTags=function(c){return this.options.parseTags(c)};a.prototype.stringifyTags=function(c){return this.options.stringifyTags(c)};a.prototype.updateField=function(e,c){var d;d="";if(c.tags){d=this.stringifyTags(c.tags)}return this.input.val(d)};a.prototype.setAnnotationTags=function(d,c){return c.tags=this.parseTags(this.input.val())};a.prototype.updateViewer=function(d,c){d=$(d);if(c.tags&&$.isArray(c.tags)&&c.tags.length){return d.addClass("annotator-tags").html(function(){var e;return e=$.map(c.tags,function(f){return'<span class="annotator-tag">'+Annotator.Util.escape(f)+"</span>"}).join(" ")})}else{return d.remove()}};return a})(Annotator.Plugin);Annotator.Plugin.Tags.filterCallback=function(i,j){var f,e,d,k,c,b,h,a;if(j==null){j=[]}d=0;e=[];if(i){e=i.split(/\s+/g);for(c=0,h=e.length;c<h;c++){f=e[c];if(j.length){for(b=0,a=j.length;b<a;b++){k=j[b];if(k.indexOf(f)!==-1){d+=1}}}}}return d===e.length};var __hasProp={}.hasOwnProperty,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};Annotator.prototype.setupPlugins=function(d,l){var b,a,j,f,c,i,h,k,e;if(d==null){d={}}if(l==null){l={}}i=Annotator.Util.getGlobal();f=["Unsupported","Auth","Tags","Filter","Store","AnnotateItPermissions"];if(i.Showdown){f.push("Markdown")}c=i.location.href.split(/#|\?/).shift()||"";j={Tags:{},Filter:{filters:[{label:Annotator._t("User"),property:"user"},{label:Annotator._t("Tags"),property:"tags"}]},Auth:{tokenUrl:d.tokenUrl||"http://annotateit.org/api/token"},Store:{prefix:d.storeUrl||"http://annotateit.org/api",annotationData:{uri:c},loadFromSearch:{uri:c}}};for(b in l){if(!__hasProp.call(l,b)){continue}a=l[b];if(__indexOf.call(f,b)<0){f.push(b)}}$.extend(true,j,l);e=[];for(h=0,k=f.length;h<k;h++){b=f[h];if(!(b in j)||j[b]){e.push(this.addPlugin(b,j[b]))}else{e.push(void 0)}}return e};
